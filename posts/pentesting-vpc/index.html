<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/fonts.css">
    
    <title>root@elmcgu.com:/# whoami</title>
    <link rel="icon" type="image/png" href="/assets/img/favicon.ico" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"
        integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <script src="/js/dark.js" defer=""></script>

</head>


<html>
<!DOCTYPE html>
<html>

<body>
  <header class="site-header">

    <div class="wrapper">
      <a class="muted small" href="https://elmcgu.github.io">root@elmcgu.com:/# whoami</a>
    </div>

  </header>
</body>

</html>

<h1>Pentesting VPC - Host private vulnerable machines in the cloud for free and access from anywhere</h1>
<p class="post-meta"><time itemprop="datePublished">March 18, 2024</time>
</p>
<h1 id="setting-up-owasp-juice-shop-on-aws-with-private-vpn-access">Setting-up OWASP Juice Shop on AWS with Private VPN Access</h1>
<h2 id="backgroundoverview">Background/Overview</h2>
<p>Preparing for a Capture The Flag (CTF) competition led me to discover OWASP&rsquo;s Juice Shop during our developer club meeting. Juice Shop, a vulnerable web app, offers free usage, enriching educational experience and craic. I&rsquo;ve been running it on a separate machine on my local network since my initial introduction but this isn&rsquo;t much good if I have a time to practice when I&rsquo;m out and about. I&rsquo;m learning cloud computing at college at the moment so I thought it&rsquo;d be interesting to set-up the vulnerable machine on AWS that&rsquo;s running all the time (making use of AWS free-tier) and isn&rsquo;t publicly accessible.
<strong>In this case I set-up OpenVPN from a simple script but for my day-to-day VPN I configure with security best practices (having a separate CA server and encrypted traffic server) which I will write about another time.</strong></p>
<h2 id="setting-up-the-vpc">Setting-up the VPC</h2>
<h3 id="cidr-block">CIDR Block</h3>
<ul>
<li><strong>Explanation</strong>: A CIDR block, simply put, is a range of IP addresses. I designated as 10.0.0.0/16 within the AWS Virtual Private Cloud (VPC).</li>
<li><strong>Steps</strong>:
<ul>
<li>Searched for the VPC service in the AWS Console and created a new VPC named pentest-vpc with a CIDR block of 10.0.0.0/16.</li>
</ul>
</li>
</ul>
<p><img src="/pentest-vpc0.png" alt=""></p>
<h2 id="create-subnets">Create Subnets</h2>
<h3 id="public-subnet">Public Subnet</h3>
<ul>
<li><strong>Explanation</strong>: Created within the VPC, the public subnet facilitates external communication. Assigned it a CIDR block within the VPC&rsquo;s range.</li>
<li><strong>Steps</strong>:
<ul>
<li>Clicked on subnets in the left-hand pane and clicked create subnet in the top-right.</li>
<li>Assigned the new subnet to the VPC and named it &ldquo;public,&rdquo; assigning it a CIDR block within the VPC CIDR block.</li>
</ul>
</li>
</ul>
<p><img src="/pentest-vpc1.png" alt=""></p>
<h3 id="private-subnet">Private Subnet</h3>
<ul>
<li><strong>Explanation</strong>: Similar to the public subnet, this is internal and inaccessible from the internet.</li>
<li><strong>Steps</strong>:
<ul>
<li>Repeated the process for creating a subnet, naming it &ldquo;private,&rdquo; and assigning another CIDR block within the VPC CIDR block.</li>
</ul>
</li>
</ul>
<h2 id="create-a-private-route-table">Create a Private Route Table</h2>
<ul>
<li><strong>Explanation</strong>: A dedicated route table for the private subnet ensures proper network routing.</li>
<li><strong>Steps</strong>:
<ul>
<li>Created a new route table, named it, and attached it to the VPC.</li>
<li>After it&rsquo;s created go to edit subnet associations and select the private subnet.</li>
</ul>
</li>
</ul>
<p><img src="/pentest-vpc5.png" alt="">
<img src="/pentest-vpc6.png" alt=""></p>
<h2 id="internet-gateway">Internet Gateway</h2>
<ul>
<li><strong>Explanation</strong>: An internet gateway connects the VPC to the internet, crucial for the public subnet&rsquo;s outbound traffic.</li>
<li><strong>Steps</strong>:
<ul>
<li>Created an Internet Gateway, named it, and attached it to the VPC.
<img src="/pentest-vpc8.png" alt=""></li>
<li>Add route in public route table from world/0.0.0.0 to the new Internet Gateway.</li>
</ul>
</li>
</ul>
<h2 id="create-nat-gateway">Create NAT Gateway</h2>
<ul>
<li><strong>Explanation</strong>: A NAT gateway allows instances in the private subnet to access the internet while remaining hidden from external threats.</li>
<li><strong>Steps</strong>:
<ul>
<li>Navigated to NAT Gateway, created one, allocated elastic IP and attached it to the public subnet.
<img src="/pentest-vpc11.png" alt=""></li>
<li>Went to the private route table we created and add a new route with 0.0.0.0 as destination and target the new NAT Gateway.</li>
<li>AWS charge for the NAT Gateway so this can be removed later after the AMI has launched Juice Shop with Docker and no longer needs outbound internet.</li>
</ul>
</li>
</ul>
<h2 id="security-groups">Security Groups</h2>
<ul>
<li><strong>Explanation</strong>: Security groups act as virtual firewalls, controlling inbound and outbound traffic for instances.</li>
<li><strong>Steps</strong>:
<ul>
<li>Created security groups for both the VPN instance and the Juice-Box instance, allowing specific traffic as required.
<img src="/pentest-vpc13.png" alt="">
<img src="/pentest-vpc14.png" alt=""></li>
</ul>
</li>
</ul>
<h2 id="spin-up-servers">Spin-up Servers</h2>
<h3 id="pentest-vpn">Pentest-VPN</h3>
<ul>
<li><strong>Explanation</strong>: An Ubuntu instance serving as the VPN server, configured with the necessary security groups and network settings.</li>
<li><strong>Steps</strong>:
<ul>
<li>Launched a new instance from the EC2 service, configured it with appropriate settings including security groups(ssh from world) and subnet(public).</li>
</ul>
</li>
</ul>
<h3 id="juice-box">Juice-Box</h3>
<ul>
<li><strong>Explanation</strong>: Deployed using an Amazon AMI, confined to the private subnet for enhanced security.</li>
<li><strong>Steps</strong>:
<ul>
<li>Launched another instance, this time selecting the Amazon AMI, locating it in private subent and assigning security group that only alllowed inbound traffic from VPC CIDR block.</li>
<li>Added Bash script in the advanced settings to auto-execute Juice-Box using Docker.
<code>#!/bin/bash</code>
<code>yum update -y</code>
<code>yum install -y docker</code>
<code>service docker start</code>
<code>docker pull bkimminich/juice-shop</code>
<code>docker run -d -p 80:3000 bkimminich/juice-shop</code></li>
</ul>
</li>
</ul>
<h2 id="openvpn-server">OpenVPN Server</h2>
<ul>
<li><strong>Explanation</strong>: Setting up OpenVPN involves connecting to the Ubuntu instance and following setup instructions. The resulting .ovpn file facilitates client connections.</li>
<li><strong>Steps</strong>:
<ul>
<li>Connected to the Ubuntu instance and followed setup instructions to install and configure OpenVPN.</li>
<li><strong>As noted before this is not how I set-up my vpn for personal use. I will detail that in another write-up.</strong></li>
<li><code>wget https://git.io/vpn -O openvpn-install.sh</code></li>
<li><code>sudo chmod +x openvpn-install.sh</code></li>
<li><code>sudo bash openvpn-install.sh</code></li>
<li>Download .ovpn file to local machine</li>
</ul>
</li>
</ul>
<h2 id="happy-hacking">Happy Hacking</h2>
<ul>
<li><strong>Explanation</strong>: Once connected to the VPN, access Juice Shop securely via its private IP address.</li>
<li><strong>Steps</strong>:
<ul>
<li>Accessed Juice Shop securely via its private IP address after connecting to the VPN.</li>
</ul>
</li>
</ul>
<p><img src="/pentest-vpc16.png" alt=""></p>
<h2 id="benefits">Benefits</h2>
<ul>
<li>
<p><strong>Security:</strong> By placing the OWASP Juice-Box instance in a private subnet, you prevent direct access from the internet, thus reducing the attack surface. This setup enhances security by limiting exposure to potential threats.</p>
</li>
<li>
<p><strong>Isolation:</strong> The separation of resources into public and private subnets provides isolation between components. The public subnet allows access to resources that need to be publicly accessible, such as the VPN server, while the private subnet hosts sensitive resources like the Juice-Box instance, shielded from external access.</p>
</li>
<li>
<p><strong>Controlled Access:</strong> Access to resources in the private subnet can be tightly controlled using VPN connections, as demonstrated in your setup. This ensures that only authorized users with VPN access can interact with the Juice-Box instance, maintaining confidentiality and integrity.</p>
</li>
<li>
<p><strong>Scalability and Flexibility:</strong> The VPC setup allows for scalability and flexibility in deploying additional services or expanding the infrastructure as needed. You can easily add more instances, adjust security group settings, or modify routing configurations without impacting the overall architecture.</p>
</li>
<li>
<p><strong>Overcoming Hardware Limitations:</strong> In cases where hardware limitations prevent running virtual machines to host target machines, utilizing cloud-based services like AWS allows for seamless deployment and scalability without being constrained by physical hardware constraints.</p>
</li>
</ul>
<p>I hope you found this post enjoyable! In the coming week, I&rsquo;ll delve into the specific exploits I&rsquo;ve employed to target the vulnerabilities within Juice Shop.</p>


<footer>
    <div>
        <h3><a href="https://elmcgu.github.io/posts">Back to all posts</a></h3>
    </div>
    <hr>
    <p>Go <a href="https://elmcgu.github.io/index.xml">here</a> for an RSS feed.</p>
</footer>

</html>